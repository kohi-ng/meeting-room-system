<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>H·ªá th·ªëng ƒëƒÉng k√Ω ph√≤ng h·ªçp ‚Äî FULL + Login Whitelist + L·ªãch Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#3b82f6; --success:#22c55e; --danger:#ef4444; --warning:#f59e0b; --border:#1f2937;
    }
    *{box-sizing:border-box;}
    body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Noto Sans",sans-serif;}
    header{border-bottom:1px solid var(--border); padding:12px 16px; position:sticky; top:0; background:rgba(15,23,42,.85); backdrop-filter:blur(6px); z-index:100; display:flex; justify-content:space-between; align-items:center;}
    header .brand{font-weight:700;}
    /* Menu b·∫±ng N√öT */
    #nav{display:flex; gap:8px;}
    .nav-btn{appearance:none; border:1px solid var(--border); background:#1f2937; color:#e5e7eb; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600;}
    .nav-btn.active{background:var(--accent); border-color:transparent; color:#fff;}
    header .user{font-size:14px; color:var(--muted);}
    main{padding:16px; max-width:1200px; margin:0 auto;}
    .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px;}
    .row{display:grid; grid-template-columns: repeat(12,1fr); gap:16px;}
    .col-3{grid-column:span 3;} .col-4{grid-column:span 4;} .col-6{grid-column:span 6;} .col-8{grid-column:span 8;} .col-12{grid-column:span 12;}
    .muted{color:var(--muted);} .hidden{display:none!important;}
    label{display:block; margin-bottom:6px; font-weight:600;}
    input,select,textarea{width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); background:#0b1220; color:#e5e7eb;}
    .btn{appearance:none; border:1px solid var(--border); background:#0b1220; color:#e5e7eb; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600;}
    .btn.primary{background:var(--accent); border-color:transparent; color:#fff;}
    .btn.success{background:var(--success); border-color:transparent; color:#fff;}
    .btn.warn{background:var(--warning); border-color:transparent; color:#000;}
    .btn.danger{background:var(--danger); border-color:transparent; color:#fff;}
    .pill{display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; background:var(--border);}
    .table{width:100%; border-collapse:collapse;}
    .table th,.table td{border-bottom:1px solid var(--border); padding:8px; text-align:left; vertical-align:top;}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border);}
    .badge.role-chair{background:rgba(59,130,246,.15); color:#93c5fd;}
    .badge.role-sec{background:rgba(34,197,94,.15); color:#86efac;}
    .badge.role-mem{background:rgba(245,158,11,.15); color:#fde68a;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono", monospace;}

    /* Th·∫ª ph√≤ng ‚Äî clickable */
    .room-card{cursor:pointer; transition:transform .1s ease, box-shadow .1s ease;}
    .room-card:hover{transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.3);}

    /* Popup (modal) */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.5);
      display:flex; align-items:center; justify-content:center; z-index:999;
    }
    .modal{background:#0b1220; border:1px solid var(--border); border-radius:12px; width:720px; max-width:95vw; padding:16px;}
    .modal header{display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:8px; margin-bottom:12px; position:static; backdrop-filter:none;}
    .modal footer{display:flex; justify-content:flex-end; gap:10px; margin-top:12px;}

    /* L·ªãch trong T·ªïng quan */
    .calendar{border:1px solid var(--border); border-radius:12px; overflow:hidden; margin-top:8px;}
    .calendar .grid{display:grid;}
    .calendar.week .grid{grid-template-columns: 100px repeat(7, 1fr);} /* c·ªôt gi·ªù + 7 ng√†y */
    .calendar.month .grid{grid-template-columns: repeat(7, 1fr);}
    .calendar .cell{border-bottom:1px solid var(--border); border-right:1px solid var(--border); padding:6px; min-height:70px;}
    .calendar .header{background:#0b1220; font-weight:700;}
    .calendar .event{background:#1f2937; border:1px solid #374151; border-radius:8px; padding:6px; margin:4px 0; font-size:12px;}
    .calendar .event.meeting{border-color:#60a5fa; background:#0b2a4a;}
  </style>
</head>
<body>
<header>
  <div class="brand">üìÖ H·ªá th·ªëng ƒëƒÉng k√Ω ph√≤ng h·ªçp</div>
  <div id="nav" class="hidden">
    <button class="nav-btn active" data-tab="dashboard">T·ªïng quan</button>
    <button class="nav-btn" data-tab="bookroom">ƒêƒÉng k√Ω ph√≤ng</button>
    <button class="nav-btn" data-tab="my">Cu·ªôc h·ªçp c·ªßa t√¥i</button>
    <button class="nav-btn" data-tab="minutes">Bi√™n b·∫£n</button>
    <button class="nav-btn" data-tab="manage">Qu·∫£n l√Ω</button>
  </div>
  <div class="user" id="userBox"></div>
</header>

<main>
  <!-- ƒêƒÉng nh·∫≠p -->
  <section id="auth" class="card">
    <h2>ƒêƒÉng nh·∫≠p</h2>
    <p class="muted">Ch·ªâ email trong <strong>whitelist</strong> m·ªõi v√†o h·ªá th·ªëng (kh√¥ng g√°n s·∫µn vai tr√≤).</p>
    <div class="row">
      <div class="col-6">
        <label>Email</label>
        <input id="loginEmail" type="email" placeholder="v√≠ d·ª•: thy@example.com" />
      </div>
      <div class="col-6" style="display:flex; align-items:flex-end; gap:8px;">
        <button class="btn primary" id="btnLogin">ƒêƒÉng nh·∫≠p</button>
        <button class="btn" id="btnAddSampleWl">N·∫°p whitelist m·∫´u</button>
      </div>
    </div>
    <div class="card" style="margin-top:12px;">
      <h3>Whitelist hi·ªán t·∫°i</h3>
      <p class="muted">C√°c email n√†y c√≥ th·ªÉ ƒëƒÉng nh·∫≠p:</p>
      <p><strong>Chu·ªói:</strong> <span id="wlPreview"></span></p>
      <ul id="wlBox"></ul>
    </div>
  </section>

  <!-- App -->
  <section id="app" class="hidden">
    <!-- Dashboard -->
    <div id="tab-dashboard" class="card">
      <h2>T·ªïng quan</h2>
      <div class="row">
        <div class="col-6">
          <div class="card">
            <h3>H√¥m nay</h3>
            <p id="todayStatus" class="muted">ƒêang t·∫£i...</p>
            <div id="todayMeetings" class="list"></div>
          </div>
        </div>
        <div class="col-6">
          <div class="card">
            <h3>Nh·∫Øc h·ªçp (1 gi·ªù t·ªõi)</h3>
            <p class="muted">Th√¥ng b√°o tr√¨nh duy·ªát s·∫Ω nh·∫Øc tr∆∞·ªõc 1 gi·ªù n·∫øu b·∫°n l√† th√†nh vi√™n cu·ªôc h·ªçp (Ch·ªß t·ªça / Th∆∞ k√≠ / Th√†nh ph·∫ßn).</p>
            <div class="card" style="margin-top:8px;">
              <h4>Trong 1 gi·ªù t·ªõi</h4>
              <p class="muted" id="remind1hSummary">ƒêang t√≠nh...</p>
              <div id="remind1hList" class="list"></div>
            </div>
            <!-- Nh·∫≠t k√Ω th√¥ng b√°o ƒë√£ g·ª≠i -->
            <div id="reminders" class="list" style="margin-top:8px;"></div>
          </div>
        </div>

        <!-- L·ªãch ngay trong T·ªïng quan -->
        <div class="col-12">
          <div class="card">
            <h3>L·ªãch t·ªïng quan</h3>
            <div class="row">
              <div class="col-3">
                <label>Ch·∫ø ƒë·ªô</label>
                <select id="dashCalMode">
                  <option value="week">Tu·∫ßn</option>
                  <option value="month">Th√°ng</option>
                </select>
              </div>
              <div class="col-3">
                <label>Ph√≤ng</label>
                <select id="dashCalRoom"></select> <!-- c√≥ "T·∫•t c·∫£ ph√≤ng" -->
              </div>
              <div class="col-6" style="display:flex; gap:8px; align-items:flex-end;">
                <button class="btn" id="dashCalPrev">‚óÄ Tr∆∞·ªõc</button>
                <button class="btn" id="dashCalNext">Ti·∫øp ‚ñ∂</button>
                <button class="btn" id="dashCalToday">H√¥m nay</button>
              </div>
            </div>
            <div id="dashCalendarView" class="calendar"></div>
          </div>
        </div>

        <div class="col-12">
          <div class="card">
            <h3>Cu·ªôc h·ªçp s·∫Øp t·ªõi (7 ng√†y)</h3>
            <table class="table" id="upcomingTable">
              <thead><tr><th>Ti√™u ƒë·ªÅ</th><th>Th·ªùi gian</th><th>Ph√≤ng</th><th>Vai tr√≤ c·ªßa t√¥i</th><th>Calendar</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ƒêƒÉng k√Ω ph√≤ng -->
    <div id="tab-bookroom" class="card hidden">
      <h2>ƒêƒÉng k√Ω ph√≤ng</h2>
      <p class="muted">B·∫•m v√†o <strong>th·∫ª ph√≤ng</strong> ƒë·ªÉ ƒëƒÉng k√Ω: th·ªùi gian, l√Ω do/ti√™u ƒë·ªÅ, t√†i li·ªáu (Drive), th√†nh vi√™n + vai tr√≤.</p>
      <div class="row" id="roomsGrid"></div>

      <div class="card" style="margin-top:16px;">
        <h3>Cu·ªôc h·ªçp/ph√≤ng t√¥i ƒë√£ ƒëƒÉng k√Ω</h3>
        <table class="table" id="myBookingsTable">
          <thead><tr><th>Ti√™u ƒë·ªÅ</th><th>Th·ªùi gian</th><th>Ph√≤ng</th><th>T√†i li·ªáu</th><th>Th√†nh vi√™n</th><th>Calendar</th><th>Xo√°</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Cu·ªôc h·ªçp c·ªßa t√¥i -->
    <div id="tab-my" class="card hidden">
      <h2>Cu·ªôc h·ªçp c·ªßa t√¥i</h2>
      <table class="table" id="myTable">
        <thead><tr><th>Ti√™u ƒë·ªÅ</th><th>Th·ªùi gian</th><th>Ph√≤ng</th><th>Vai tr√≤ c·ªßa t√¥i</th><th>T√†i li·ªáu</th><th>Bi√™n b·∫£n</th><th>Calendar</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Bi√™n b·∫£n -->
    <div id="tab-minutes" class="card hidden">
      <h2>Th√™m bi√™n b·∫£n h·ªçp (ch·ªâ Th∆∞ k√≠)</h2>
      <div class="row">
        <div class="col-6"><label>Ch·ªçn cu·ªôc h·ªçp</label><select id="minutesMeeting"></select></div>
        <div class="col-6"><label>Link bi√™n b·∫£n (Google Drive)</label><input id="minutesUrl" type="url" placeholder="https://drive.google.com/..." /></div>
      </div>
      <div style="margin-top:10px;"><button class="btn success" id="btnSaveMinutes">L∆∞u bi√™n b·∫£n</button></div>
    </div>

    <!-- Qu·∫£n l√Ω: hi·ªÉn th·ªã whitelist -->
    <div id="tab-manage" class="card hidden">
      <h2>Qu·∫£n l√Ω ‚Äî Danh s√°ch email ƒë∆∞·ª£c ph√©p ƒëƒÉng nh·∫≠p</h2>
      <p class="muted">Danh s√°ch whitelist (ch·ªâ hi·ªÉn th·ªã):</p>
      <div class="card">
        <p><strong>T·ªïng s·ªë:</strong> <span id="wlCount">0</span></p>
        <ul id="wlList"></ul>
      </div>
    </div>
  </section>
</main>

<!-- Modal ƒëƒÉng k√Ω ph√≤ng -->
<div id="bookingModal" class="modal-backdrop hidden">
  <div class="modal">
    <header>
      <h3 id="modalTitle">ƒêƒÉng k√Ω ph√≤ng</h3>
      <button class="btn danger" id="modalClose">ƒê√≥ng</button>
    </header>
    <div class="row">
      <div class="col-12"><label>Ph√≤ng</label><input id="modalRoomName" type="text" readonly /></div>
      <div class="col-6"><label>B·∫Øt ƒë·∫ßu</label><input id="modalStart" type="datetime-local" /></div>
      <div class="col-6"><label>K·∫øt th√∫c</label><input id="modalEnd" type="datetime-local" /></div>
      <div class="col-12"><label>L√Ω do / Ti√™u ƒë·ªÅ cu·ªôc h·ªçp</label><input id="modalTitleInput" type="text" placeholder="VD: √în t·∫≠p, ph·ªèng v·∫•n, workshop..." /></div>

      <div class="col-12">
        <label>T√†i li·ªáu (Google Drive URL)</label>
        <div style="display:flex; gap:8px;">
          <input id="docUrlInput" type="url" placeholder="https://drive.google.com/..." />
          <button class="btn" id="btnAddDoc">Th√™m</button>
        </div>
        <div id="docList" class="list" style="margin-top:8px;"></div>
      </div>

      <div class="col-12">
        <label>Th√†nh vi√™n & vai tr√≤</label>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <input id="attEmailInput" type="email" placeholder="email th√†nh vi√™n" style="flex:1;" />
          <select id="attRoleInput">
            <option value="chair">Ch·ªß t·ªça</option>
            <option value="sec">Th∆∞ k√≠</option>
            <option value="mem">Th√†nh ph·∫ßn</option>
          </select>
          <button class="btn" id="btnAddAtt">Th√™m th√†nh vi√™n</button>
        </div>
        <div id="attList" class="list" style="margin-top:8px;"></div>
        <p class="muted" style="margin-top:6px;">L∆∞u √Ω: email ph·∫£i c√≥ trong whitelist h·ªá th·ªëng.</p>
      </div>
    </div>
    <footer>
      <button class="btn success" id="modalConfirm">X√°c nh·∫≠n ƒëƒÉng k√Ω</button>
    </footer>
  </div>
</div>

<script>
/* =============================
   Seed d·ªØ li·ªáu v√†o localStorage n·∫øu tr·ªëng
   ============================= */
const seedIfEmpty = (key, value) => {
  if (!localStorage.getItem(key)) localStorage.setItem(key, JSON.stringify(value));
};
seedIfEmpty("whitelist", ["thy@example.com","hieu@example.com","alice@example.com","bob@example.com"]);
seedIfEmpty("rooms", [
  { id:"R201", name:"Ph√≤ng 201", capacity:12, location:"To√† nh√† A - T·∫ßng 2" },
  { id:"R305", name:"Ph√≤ng 305", capacity:20, location:"To√† nh√† B - T·∫ßng 3" },
  { id:"R501", name:"Ph√≤ng 501", capacity:8,  location:"To√† nh√† C - T·∫ßng 5" }
]);
seedIfEmpty("meetings", []); // t·∫•t c·∫£ ƒëƒÉng k√Ω ph√≤ng ƒë∆∞·ª£c l∆∞u th√†nh 'meeting'

/* =============================
   Store helpers
   ============================= */
const store = {
  getWhitelist(){
    try { return JSON.parse(localStorage.getItem("whitelist")||"[]"); }
    catch(e){ console.error("Whitelist parse error", e); return []; }
  },
  setWhitelist(list){ localStorage.setItem("whitelist", JSON.stringify(list)); },
  getRooms(){ return JSON.parse(localStorage.getItem("rooms")||"[]"); },
  getMeetings(){ return JSON.parse(localStorage.getItem("meetings")||"[]"); },
  setMeetings(a){ localStorage.setItem("meetings", JSON.stringify(a)); },
};

const ROLES = {
  chair: { label: "Ch·ªß t·ªça", cls: "role-chair" },
  sec:   { label: "Th∆∞ k√≠",   cls: "role-sec"   },
  mem:   { label: "Th√†nh ph·∫ßn", cls: "role-mem" }
};

const state = {
  userEmail:null,
  currentRoom:null,
  docs:[],
  attendees:[],
  reminderTimers:[],
  // L·ªãch trong T·ªïng quan
  dCalMode:"week",
  dCalAnchor:new Date(),
  dCalRoom:"*"
};

/* =============================
   Ti·ªán √≠ch & format
   ============================= */
function fmtDate(d){ return d.toLocaleString("vi-VN",{hour12:false}); }
function fmtRange(s,e){ return `${fmtDate(s)} ‚Äî ${fmtDate(e)}`; }
function uid(){ return Math.random().toString(36).slice(2,10); }
function rangesConflict(aStart,aEnd,bStart,bEnd){ return (aStart < bEnd) && (aEnd > bStart); }
function toUTCGCal(dt){
  const y=dt.getUTCFullYear(), m=String(dt.getUTCMonth()+1).padStart(2,"0"), d=String(dt.getUTCDate()).padStart(2,"0");
  const hh=String(dt.getUTCHours()).padStart(2,"0"), mm=String(dt.getUTCMinutes()).padStart(2,"0"), ss=String(dt.getUTCSeconds()).padStart(2,"0");
  return `${y}${m}${d}T${hh}${mm}${ss}Z`;
}
function buildGCalLink(meeting){
  const rooms=store.getRooms(); const room=rooms.find(r=>r.id===meeting.roomId);
  const s=new Date(meeting.start), e=new Date(meeting.end);
  const title=encodeURIComponent(meeting.title);
  const dates=`${toUTCGCal(s)}/${toUTCGCal(e)}`;
  const loc=encodeURIComponent(room ? `${room.name} - ${room.location}` : "");
  const detailsText=`Ph√≤ng: ${room ? room.name : ""}\nT√†i li·ªáu: ${meeting.docs.join(", ")}\nTh√†nh vi√™n: ${meeting.attendees.map(a=>`${a.email} (${ROLES[a.role].label})`).join(", ")}\nGhi ch√∫: ${meeting.notes||""}\nNh·∫Øc: 1 gi·ªù tr∆∞·ªõc (h√£y ƒë·∫∑t Reminder trong s·ª± ki·ªán).`;
  return `https://calendar.google.com/calendar/u/0/r/eventedit?text=${title}&dates=${dates}&location=${loc}&details=${encodeURIComponent(detailsText)}`;
}
function dayStart(dt){ return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()); }
function notify(title, body){
  if (!("Notification" in window)) return;
  if (Notification.permission === "granted") new Notification(title,{body});
}

/* =============================
   ƒêi·ªÅu h∆∞·ªõng tab (n√∫t)
   ============================= */
function showTab(tabName) {
  document.querySelectorAll(".nav-btn").forEach(x => x.classList.remove("active"));
  const currentBtn = document.querySelector(`.nav-btn[data-tab="${tabName}"]`);
  if (currentBtn) currentBtn.classList.add("active");
  document.querySelectorAll("#app > div").forEach(sec => sec.classList.add("hidden"));
  const target = document.getElementById("tab-" + tabName);
  if (target) target.classList.remove("hidden");
}
document.getElementById("nav").addEventListener("click", (e) => {
  const btn = e.target.closest(".nav-btn[data-tab]");
  if (!btn) return;
  showTab(btn.getAttribute("data-tab"));
});

/* =============================
   Hi·ªÉn th·ªã whitelist tr√™n m√†n h√¨nh Login
   ============================= */
function renderLoginWhitelist() {
  const wl = store.getWhitelist();
  document.getElementById("wlPreview").textContent = wl.join(", ");
  document.getElementById("wlBox").innerHTML = wl.map(e => `<li class="pill">‚úâÔ∏è ${e}</li>`).join("");
}
document.addEventListener("DOMContentLoaded", renderLoginWhitelist);

/* Seed nhanh whitelist m·∫´u (n·∫øu tr·ªëng) */
document.getElementById("btnAddSampleWl").addEventListener("click", ()=>{
  const sample = ["thy@example.com","hieu@example.com","alice@example.com","bob@example.com"];
  store.setWhitelist(sample);
  renderLoginWhitelist();
  alert("ƒê√£ n·∫°p whitelist m·∫´u.");
});

/* =============================
   ƒêƒÉng nh·∫≠p
   ============================= */
document.getElementById("btnLogin").addEventListener("click", () => {
  const email=(document.getElementById("loginEmail").value||"").trim().toLowerCase();
  const wl=store.getWhitelist();
  if (!email){ alert("Vui l√≤ng nh·∫≠p email"); return; }
  if (!Array.isArray(wl) || wl.length===0){ alert("Whitelist tr·ªëng. H√£y n·∫°p whitelist m·∫´u ho·∫∑c c·∫•u h√¨nh whitelist tr∆∞·ªõc."); return; }
  if (!wl.includes(email)){ alert("Email kh√¥ng n·∫±m trong whitelist."); return; }

  startApp(email);
});

/* V√†o app sau khi login */
function startApp(email){
  state.userEmail=email;

  // Hi·ªÉn th·ªã app
  document.getElementById("auth").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  document.getElementById("nav").classList.remove("hidden");

  // User + logout
  document.getElementById("userBox").innerHTML =
    `üë§ ${email} <button class="btn" id="btnLogout" style="margin-left:8px;">ƒêƒÉng xu·∫•t</button>`;
  document.getElementById("btnLogout").addEventListener("click", () => location.reload());

  // Render
  renderRoomsGrid();
  renderDashboard();
  renderMyMeetings();
  renderMyBookingsTable();
  renderMinutesSelector();
  renderManage();

  // L·ªãch trong T·ªïng quan: kh·ªüi t·∫°o select ph√≤ng (c√≥ "T·∫•t c·∫£ ph√≤ng")
  const rooms = store.getRooms();
  const dashRoomSel = document.getElementById("dashCalRoom");
  dashRoomSel.innerHTML = `<option value="*">T·∫•t c·∫£ ph√≤ng</option>` + rooms.map(r=>`<option value="${r.id}">${r.name}</option>`).join("");
  dashRoomSel.value = "*";
  state.dCalRoom = "*";
  renderDashboardCalendar();

  // Controls cho l·ªãch
  document.getElementById("dashCalMode").addEventListener("change", (e)=>{ state.dCalMode = e.target.value; renderDashboardCalendar(); });
  document.getElementById("dashCalRoom").addEventListener("change", (e)=>{ state.dCalRoom = e.target.value; renderDashboardCalendar(); });
  document.getElementById("dashCalPrev").addEventListener("click", ()=> shiftDashboardCalendar(-1));
  document.getElementById("dashCalNext").addEventListener("click", ()=> shiftDashboardCalendar(1));
  document.getElementById("dashCalToday").addEventListener("click", ()=>{ state.dCalAnchor = new Date(); renderDashboardCalendar(); });

  // Permissions
  if ("Notification" in window && Notification.permission!=="granted") Notification.requestPermission();

  // M·ªü m·∫∑c ƒë·ªãnh
  showTab("dashboard");
}

/* =============================
   Dashboard (H√¥m nay + Nh·∫Øc 1h + L·ªãch + B·∫£ng 7d)
   ============================= */
function renderDashboard(){
  const meetings=store.getMeetings().sort((a,b)=>new Date(a.start)-new Date(b.start));
  const today=dayStart(new Date());
  const my=meetings.filter(m=>m.attendees.some(a=>a.email===state.userEmail));

  // H√¥m nay
  const todayList=my.filter(m=> dayStart(new Date(m.start)).getTime()===today.getTime());
  document.getElementById("todayStatus").textContent =
    todayList.length ? `H√¥m nay b·∫°n c√≥ ${todayList.length} cu·ªôc h·ªçp/ƒëƒÉng k√Ω ph√≤ng.` : "H√¥m nay b·∫°n kh√¥ng c√≥ cu·ªôc h·ªçp n√†o.";
  document.getElementById("todayMeetings").innerHTML = todayList.map(m=>{
    const rooms=store.getRooms(); const room=rooms.find(r=>r.id===m.roomId);
    const myRole = m.attendees.find(a=>a.email===state.userEmail)?.role || "mem";
    return `<div class="pill"><strong>${m.title}</strong> ‚Äî ${fmtRange(new Date(m.start), new Date(m.end))}
      <span class="badge">${room?room.name:""}</span>
      <span class="badge ${ROLES[myRole].cls}">${ROLES[myRole].label}</span></div>`;
  }).join("");

  // Nh·∫Øc trong 1 gi·ªù t·ªõi (UI summary + list theo ph√≤ng)
  renderReminders1h(my);

  // S·∫Øp t·ªõi 7 ng√†y (b·∫£ng chi ti·∫øt)
  const now=new Date(), in7=new Date(now.getTime()+7*24*3600*1000);
  const upcoming=my.filter(m=>new Date(m.start)>=now && new Date(m.start)<=in7);
  const tbody=document.querySelector("#upcomingTable tbody");
  tbody.innerHTML = upcoming.map(m=>{
    const rooms=store.getRooms(); const room=rooms.find(r=>r.id===m.roomId);
    const myRole = m.attendees.find(a=>a.email===state.userEmail)?.role || "mem";
    return `<tr>
      <td>${m.title}</td>
      <td>${fmtRange(new Date(m.start), new Date(m.end))}</td>
      <td>${room?room.name:""}</td>
      <td><span class="badge ${ROLES[myRole].cls}">${ROLES[myRole].label}</span></td>
      <td>${buildGCalLink(m)}Add to Google Calendar</a></td>
    </tr>`;
  }).join("");

  // (re)schedule 1h reminders
  document.getElementById("reminders").innerHTML="";
  my.forEach(scheduleReminderFor);

  // C·∫≠p nh·∫≠t l·ªãch
  renderDashboardCalendar();
}

function renderReminders1h(myMeetings){
  const now = new Date();
  const in1h = new Date(now.getTime() + 60*60*1000);
  const rooms=store.getRooms();
  const within1h = myMeetings.filter(m => new Date(m.start) > now && new Date(m.start) <= in1h);

  const rooms1h = Array.from(new Set(within1h.map(m => m.roomId)));
  document.getElementById("remind1hSummary").textContent =
    `Trong 1 gi·ªù t·ªõi: ${within1h.length} cu·ªôc h·ªçp ‚Ä¢ ${rooms1h.length} ph√≤ng`;

  document.getElementById("remind1hList").innerHTML = within1h.map(m => {
    const room = rooms.find(r => r.id === m.roomId);
    const myRole = m.attendees.find(a => a.email === state.userEmail)?.role || "mem";
    return `<div class="pill">
      üîî <strong>${m.title}</strong> ‚Äî b·∫Øt ƒë·∫ßu ${fmtDate(new Date(m.start))}
      <span class="badge">${room ? room.name : m.roomId}</span>
      <span class="badge ${ROLES[myRole].cls}">${ROLES[myRole].label}</span>
    </div>`;
  }).join("");
}

/* =============================
   L·ªãch trong T·ªïng quan (Tu·∫ßn/Th√°ng, l·ªçc ph√≤ng)
   ============================= */
function renderDashboardCalendar(){
  const container = document.getElementById("dashCalendarView");
  const mode = state.dCalMode;
  const roomId = state.dCalRoom; // "*" = t·∫•t c·∫£ ph√≤ng
  const meetingsAll = store.getMeetings();
  const meetings = roomId==="*" ? meetingsAll : meetingsAll.filter(m=>m.roomId===roomId);

  if (mode==="week"){
    container.className = "calendar week";
    renderWeekCalendar(container, state.dCalAnchor, meetings);
  } else {
    container.className = "calendar month";
    renderMonthCalendar(container, state.dCalAnchor, meetings);
  }
}
function shiftDashboardCalendar(delta){
  if (state.dCalMode==="week"){
    state.dCalAnchor = new Date(state.dCalAnchor.getTime() + delta*7*24*3600*1000);
  } else {
    const a=state.dCalAnchor; state.dCalAnchor = new Date(a.getFullYear(), a.getMonth()+delta, 1);
  }
  renderDashboardCalendar();
}
function renderWeekCalendar(container, anchor, meetings){
  // T√≠nh th·ª© Hai c·ªßa tu·∫ßn
  const d=new Date(anchor); const day=d.getDay(); const diff=(day+6)%7; // Mon=0...Sun=6
  const monday = new Date(d.getFullYear(), d.getMonth(), d.getDate()-diff);
  const days = Array.from({length:7}, (_,i)=> new Date(monday.getFullYear(), monday.getMonth(), monday.getDate()+i));
  const hours = Array.from({length:11}, (_,i)=> i+8); // 8h -> 18h (demo)
  const header = `<div class="grid">
    <div class="cell header">Gi·ªù</div>
    ${days.map(dt=>`<div class="cell header">${dt.toLocaleDateString("vi-VN",{weekday:"short", day:"2-digit", month:"2-digit"})}</div>`).join("")}
  </div>`;
  let grid = `<div class="grid">`;
  hours.forEach(h=>{
    grid += `<div class="cell"><strong>${String(h).padStart(2,"0")}:00</strong></div>`;
    days.forEach(dt=>{
      const cellItems = [];
      const cellStart = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate(), h, 0, 0);
      const cellEnd   = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate(), h+1, 0, 0);
      meetings.forEach(m=>{
        const ms=new Date(m.start), me=new Date(m.end);
        if (rangesConflict(cellStart,cellEnd,ms,me)) {
          const room = store.getRooms().find(r=>r.id===m.roomId);
          cellItems.push(`<div class="event meeting">üìå ${m.title}<br><span class="muted">${room?room.name:""} ‚Ä¢ ${fmtRange(ms,me)}</span></div>`);
        }
      });
      grid += `<div class="cell">${cellItems.join("")}</div>`;
    });
  });
  grid += `</div>`;
  container.innerHTML = header + grid;
}
function renderMonthCalendar(container, anchor, meetings){
  const first = new Date(anchor.getFullYear(), anchor.getMonth(), 1);
  const startGrid = new Date(first);
  startGrid.setDate(1 - ((first.getDay()+6)%7)); // Monday-based
  const totalCells = 6*7; // 6 rows x 7 days
  const header = `<div class="grid">
    ${["T2","T3","T4","T5","T6","T7","CN"].map(d=>`<div class="cell header">${d}</div>`).join("")}
  </div>`;
  let grid = `<div class="grid">`;
  for (let i=0;i<totalCells;i++){
    const dt = new Date(startGrid.getFullYear(), startGrid.getMonth(), startGrid.getDate()+i);
    const inMonth = dt.getMonth()===anchor.getMonth();
    const items=[];
    meetings.forEach(m=>{
      const ms=new Date(m.start), me=new Date(m.end);
      if (dayStart(ms).getTime()===dayStart(dt).getTime()){
        const room = store.getRooms().find(r=>r.id===m.roomId);
        items.push(`<div class="event meeting">üìå ${m.title}<br><span class="muted">${room?room.name:""} ‚Ä¢ ${ms.toLocaleTimeString("vi-VN",{hour:'2-digit',minute:'2-digit'})}-${me.toLocaleTimeString("vi-VN",{hour:'2-digit',minute:'2-digit'})}</span></div>`);
      }
    });
    grid += `<div class="cell" style="opacity:${inMonth?1:.5}">
      <div style="font-weight:700; margin-bottom:4px;">${dt.getDate()}</div>
      ${items.join("")}
    </div>`;
  }
  grid += `</div>`;
  container.innerHTML = header + grid;
}

/* =============================
   Cu·ªôc h·ªçp c·ªßa t√¥i
   ============================= */
function renderMyMeetings(){
  const meetings=store.getMeetings();
  const rooms=store.getRooms();
  const my=meetings.filter(m=>m.attendees.some(a=>a.email===state.userEmail));
  const tbody=document.querySelector("#myTable tbody");
  tbody.innerHTML = my.map(m=>{
    const room=rooms.find(r=>r.id===m.roomId);
    const myRole = m.attendees.find(a=>a.email===state.userEmail)?.role || "mem";
    return `<tr>
      <td>${m.title}</td>
      <td>${fmtRange(new Date(m.start), new Date(m.end))}</td>
      <td>${room?room.name:""}</td>
      <td><span class="badge ${ROLES[myRole].cls}">${ROLES[myRole].label}</span></td>
      <td>${m.docs.map(u=>`${u}T√†i li·ªáu</a>`).join(" ") || '<span class="muted">‚Äî</span>'}</td>
      <td>${m.minutesUrl ? `${m.minutesUrl}Bi√™n b·∫£n</a>` : `<span class="muted">Ch∆∞a c√≥</span>`}</td>
      <td>${buildGCalLink(m)}Add to Calendar</a></td>
    </tr>`;
  }).join("");
}

/* =============================
   NH·∫Æc H·ªåP 1 GI·ªú TR∆Ø·ªöC (Notification)
   ============================= */
function scheduleReminderFor(meeting){
  state.reminderTimers = state.reminderTimers.filter(t=>{ if (t.id===meeting.id){ clearTimeout(t.timer); return false; } return true; });
  const start=new Date(meeting.start);
  const delta = start.getTime() - Date.now() - 60*60*1000;
  if (delta<=0) return;
  const amIn = meeting.attendees.some(a=>a.email===state.userEmail); // √°p d·ª•ng nh∆∞ nhau cho m·ªçi vai tr√≤
  if (!amIn) return;
  const timer=setTimeout(()=>{
    const rooms=store.getRooms(); const room=rooms.find(r=>r.id===meeting.roomId);
    notify("Nh·∫Øc h·ªçp", `${meeting.title} (ph√≤ng ${room?room.name:meeting.roomId}) b·∫Øt ƒë·∫ßu l√∫c ${fmtDate(start)} ‚Äî nh·∫Øc tr∆∞·ªõc 1 gi·ªù`);
    const r=document.getElementById("reminders");
    const div=document.createElement("div"); div.className="pill";
    div.innerHTML=`üîî Nh·∫Øc: ${meeting.title} ‚Äî ${fmtDate(start)} ‚Ä¢ <span class="badge">${room?room.name:""}</span>`;
    r.appendChild(div);
  }, delta);
  state.reminderTimers.push({id:meeting.id, timer});
}

/* =============================
   ƒêƒÉng k√Ω ph√≤ng (th·∫ª + modal)
   ============================= */
function renderRoomsGrid(){
  const rooms = store.getRooms();
  const grid = document.getElementById("roomsGrid");
  grid.innerHTML = "";
  rooms.forEach(r => {
    const col = document.createElement("div"); col.className = "col-4";
    col.innerHTML = `
      <div class="card room-card" data-room-id="${r.id}">
        <h3>${r.name}</h3>
        <p class="muted">ID: <span class="mono">${r.id}</span></p>
        <p>V·ªã tr√≠: ${r.location}</p>
        <p>S·ª©c ch·ª©a: <strong>${r.capacity}</strong></p>
        <div style="margin-top:8px;">
          <button class="btn primary">ƒêƒÉng k√Ω ph√≤ng n√†y</button>
        </div>
      </div>`;
    grid.appendChild(col);
  });

  grid.addEventListener("click", (e) => {
    const card = e.target.closest(".room-card");
    if (!card) return;
    const roomId = card.getAttribute("data-room-id");
    const room = store.getRooms().find(x => x.id === roomId);
    if (!room) { alert("Kh√¥ng t√¨m th·∫•y ph√≤ng."); return; }
    openBookingModal(room);
  });
}

// Modal logic & form data
const modal = document.getElementById("bookingModal");
const modalTitle = document.getElementById("modalTitle");
const modalRoomName = document.getElementById("modalRoomName");
const modalStart = document.getElementById("modalStart");
const modalEnd = document.getElementById("modalEnd");
const modalTitleInput = document.getElementById("modalTitleInput");

// Docs
const docUrlInput = document.getElementById("docUrlInput");
const docList = document.getElementById("docList");

// Attendees
const attEmailInput = document.getElementById("attEmailInput");
const attRoleInput  = document.getElementById("attRoleInput");
const attList = document.getElementById("attList");

document.getElementById("modalClose").addEventListener("click", closeBookingModal);
document.getElementById("modalConfirm").addEventListener("click", confirmBooking);
document.getElementById("btnAddDoc").addEventListener("click", addDoc);
document.getElementById("btnAddAtt").addEventListener("click", addAtt);

function addDoc(){
  const url=(docUrlInput.value||"").trim();
  if (!url){ alert("Nh·∫≠p link t√†i li·ªáu (Google Drive)"); return; }
  state.docs.push(url);
  docUrlInput.value="";
  renderDocs();
}
function renderDocs(){
  docList.innerHTML = state.docs.map((u,i)=>`
    <div class="pill"><span>üìÑ</span> ${u}${u}</a>
      <button class="btn danger" style="padding:4px 8px;margin-left:6px;" onclick="removeDoc(${i})">X</button>
    </div>`).join("");
}
function removeDoc(i){ state.docs.splice(i,1); renderDocs(); }

function addAtt(){
  const email=(attEmailInput.value||"").trim().toLowerCase();
  const role=attRoleInput.value;
  const wl=store.getWhitelist();
  if (!email){ alert("Nh·∫≠p email th√†nh vi√™n"); return; }
  if (!wl.includes(email)){ alert("Email n√†y ch∆∞a trong whitelist h·ªá th·ªëng"); return; }
  if (role==="chair" && state.attendees.some(a=>a.role==="chair")){ alert("M·ªói cu·ªôc h·ªçp ch·ªâ 1 Ch·ªß t·ªça."); return; }
  state.attendees.push({email,role});
  attEmailInput.value=""; renderAttendees();
}
function renderAttendees(){
  attList.innerHTML = state.attendees.map((a,i)=>`
    <div class="pill"><span>üë§ ${a.email}</span>
      <span class="badge ${ROLES[a.role].cls}">${ROLES[a.role].label}</span>
      <button class="btn danger" style="padding:4px 8px;margin-left:6px;" onclick="removeAtt(${i})">X</button>
    </div>`).join("");
}
function removeAtt(i){ state.attendees.splice(i,1); renderAttendees(); }

function openBookingModal(room){
  state.currentRoom = room;
  state.docs = [];
  state.attendees = [];
  modalTitle.textContent = `ƒêƒÉng k√Ω: ${room.name}`;
  modalRoomName.value = `${room.name} (${room.location}) ‚Ä¢ S·ª©c ch·ª©a ${room.capacity}`;
  modalStart.value = ""; modalEnd.value = ""; modalTitleInput.value="";
  renderDocs(); renderAttendees();
  modal.classList.remove("hidden");
}
function closeBookingModal(){
  modal.classList.add("hidden");
}

function confirmBooking(){
  const room = state.currentRoom;
  if (!room){ alert("L·ªói: ch∆∞a ch·ªçn ph√≤ng."); return; }

  const startStr = modalStart.value;
  const endStr = modalEnd.value;
  const title = (modalTitleInput.value || "").trim();

  if (!startStr || !endStr){ alert("Ch·ªçn th·ªùi gian b·∫Øt ƒë·∫ßu/k·∫øt th√∫c."); return; }
  const start = new Date(startStr);
  const end = new Date(endStr);
  if (isNaN(start) || isNaN(end) || end <= start){ alert("Th·ªùi gian kh√¥ng h·ª£p l·ªá."); return; }
  if (!title){ alert("Nh·∫≠p l√Ω do/ti√™u ƒë·ªÅ cu·ªôc h·ªçp."); return; }
  // B·∫Øt bu·ªôc c√≥ √≠t nh·∫•t 1 Th∆∞ k√≠ ƒë·ªÉ sau n√†y th√™m bi√™n b·∫£n
  if (!state.attendees.some(a=>a.role==="sec")){ alert("C·∫ßn √≠t nh·∫•t 1 Th∆∞ k√≠ trong cu·ªôc h·ªçp/ƒëƒÉng k√Ω ph√≤ng."); return; }
  // Ng∆∞·ªùi t·∫°o auto tham gia n·∫øu ch∆∞a c√≥
  if (!state.attendees.some(a=>a.email===state.userEmail)) state.attendees.push({email:state.userEmail, role:"mem"});

  const meetings=store.getMeetings();
  // Xung ƒë·ªôt c√πng ph√≤ng
  const conflict = meetings.some(m => m.roomId===room.id && rangesConflict(start,end,new Date(m.start),new Date(m.end)));
  if (conflict){ alert("Khung gi·ªù n√†y ƒë√£ tr√πng v·ªõi cu·ªôc h·ªçp/ƒëƒÉng k√Ω ph√≤ng kh√°c. Vui l√≤ng ch·ªçn khung gi·ªù kh√°c."); return; }

  const meeting = {
    id: uid(),
    title,
    start: start.toISOString(),
    end: end.toISOString(),
    roomId: room.id,
    docs: [...state.docs],
    attendees: [...state.attendees],
    notes: "",
    creator: state.userEmail,
    minutesUrl: null
  };
  meetings.push(meeting); store.setMeetings(meetings);

  scheduleReminderFor(meeting);
  alert("ƒê√£ ƒëƒÉng k√Ω ph√≤ng th√†nh c√¥ng!");
  closeBookingModal();
  renderDashboard();
  renderMyMeetings();
  renderMyBookingsTable();
  renderMinutesSelector();
}

/* =============================
   B·∫£ng ‚ÄúCu·ªôc h·ªçp/ph√≤ng t√¥i ƒë√£ ƒëƒÉng k√Ω‚Äù
   ============================= */
function renderMyBookingsTable(){
  const rooms=store.getRooms();
  const meetings = store.getMeetings().filter(m=>m.creator===state.userEmail).sort((a,b)=>new Date(a.start)-new Date(b.start));
  const tbody = document.querySelector("#myBookingsTable tbody");
  tbody.innerHTML = meetings.map(m=>{
    const room=rooms.find(r=>r.id===m.roomId);
    const members=m.attendees.map(a=>`<span class="badge ${ROLES[a.role].cls}">${a.email} ‚Ä¢ ${ROLES[a.role].label}</span>`).join(" ");
    return `<tr>
      <td>${m.title}</td>
      <td>${fmtRange(new Date(m.start), new Date(m.end))}</td>
      <td>${room ? room.name : m.roomId}</td>
      <td>${m.docs.map(u=>`${u}T√†i li·ªáu</a>`).join(" ") || '<span class="muted">‚Äî</span>'}</td>
      <td>${members}</td>
      <td>${buildGCalLink(m)}Add to Calendar</a></td>
      <td><button class="btn danger" onclick="deleteMyBooking('${m.id}')">Xo√°</button></td>
    </tr>`;
  }).join("");
}
function deleteMyBooking(id){
  const meetings=store.getMeetings();
  const idx=meetings.findIndex(m=>m.id===id && m.creator===state.userEmail);
  if (idx<0){ alert("Kh√¥ng t√¨m th·∫•y ho·∫∑c b·∫°n kh√¥ng ph·∫£i ng∆∞·ªùi t·∫°o."); return; }
  meetings.splice(idx,1); store.setMeetings(meetings);
  renderMyBookingsTable(); renderDashboard(); renderMyMeetings(); renderMinutesSelector();
}

/* =============================
   Bi√™n b·∫£n (ch·ªâ Th∆∞ k√≠)
   ============================= */
function renderMinutesSelector(){
  const meetings=store.getMeetings();
  const secs=meetings.filter(m=>m.attendees.some(a=>a.email===state.userEmail && a.role==="sec"));
  const sel=document.getElementById("minutesMeeting");
  sel.innerHTML = secs.map(m=>`<option value="${m.id}">${m.title} ‚Äî ${fmtDate(new Date(m.start))}</option>`).join("");
}
document.getElementById("btnSaveMinutes").addEventListener("click", ()=>{
  const mid=document.getElementById("minutesMeeting").value;
  const url=(document.getElementById("minutesUrl").value||"").trim();
  if (!mid){ alert("Ch·ªçn cu·ªôc h·ªçp"); return; }
  if (!url){ alert("Nh·∫≠p link bi√™n b·∫£n (Google Drive)"); return; }
  const meetings=store.getMeetings();
  const idx=meetings.findIndex(m=>m.id===mid);
  if (idx<0){ alert("Kh√¥ng t√¨m th·∫•y cu·ªôc h·ªçp"); return; }
  const isSec=meetings[idx].attendees.some(a=>a.email===state.userEmail && a.role==="sec");
  if (!isSec){ alert("Ch·ªâ Th∆∞ k√≠ c·ªßa cu·ªôc h·ªçp m·ªõi ƒë∆∞·ª£c th√™m bi√™n b·∫£n."); return; }
  meetings[idx].minutesUrl=url; store.setMeetings(meetings);
  alert("ƒê√£ l∆∞u bi√™n b·∫£n!");
  document.getElementById("minutesUrl").value="";
  renderMyMeetings();
});

/* =============================
   Qu·∫£n l√Ω ‚Äî hi·ªÉn th·ªã whitelist
   ============================= */
function renderManage(){
  const wl = store.getWhitelist();
  document.getElementById("wlCount").textContent = wl.length;
  const ul = document.getElementById("wlList");
  ul.innerHTML = wl.map(e => `<li class="pill">‚úâÔ∏è ${e}</li>`).join("");
}
</script>
</body>
</html>